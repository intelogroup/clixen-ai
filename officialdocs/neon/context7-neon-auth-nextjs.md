# Neon Authentication with Next.js - Context7 Documentation

Source: Context7 MCP Server from `/websites/neon` (Official Neon Documentation)

## Quick Setup

### 1. Neon Auth Setup Wizard
```bash
npx @stackframe/init-stack@latest
```
This command automatically configures authentication routes, layout wrappers, and handlers for Next.js App Router.

### 2. Environment Variables
```env
# Neon Auth environment variables for Next.js
NEXT_PUBLIC_STACK_PROJECT_ID=YOUR_NEON_AUTH_PROJECT_ID
NEXT_PUBLIC_STACK_PUBLISHABLE_CLIENT_KEY=YOUR_NEON_AUTH_PUBLISHABLE_KEY
STACK_SECRET_SERVER_KEY=YOUR_NEON_AUTH_SECRET_KEY

# Your Neon connection string
DATABASE_URL=YOUR_NEON_CONNECTION_STRING
```

## Authentication Patterns

### 1. Auth.js with Neon Postgres Adapter
```typescript
/// auth.ts
import NextAuth from 'next-auth';
import Resend from 'next-auth/providers/resend';
import PostgresAdapter from '@auth/pg-adapter';
import { Pool } from '@neondatabase/serverless';

// *DO NOT* create a `Pool` here, outside the request handler.

export const { handlers, auth, signIn, signOut } = NextAuth(() => {
  const pool = new Pool({ connectionString: process.env.DATABASE_URL });
  return {
    adapter: PostgresAdapter(pool),
    providers: [Resend({ from: 'Test <onboarding@resend.dev>' })],
  };
});
```

### 2. API Routes Setup
```typescript
/// app/api/auth/[...nextauth]/route.ts
import { handlers } from '@/auth';

export const { GET, POST } = handlers;
```

### 3. Middleware for Clerk Integration
```typescript
/// middleware.ts
import { clerkMiddleware } from '@clerk/nextjs/server';

export default clerkMiddleware();

export const config = {
  matcher: [
    // Skip Next.js internals and all static files, unless found in search params
    '/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',
    // Always run for API routes
    '/(api|trpc)(.*)',
  ],
};
```

## Page Integration Examples

### 1. Main Page with Authentication
```typescript
import { auth } from '@/auth';
import TodoList from '@/app/TodoList';
import { Pool } from '@neondatabase/serverless';

async function getTodos(userId: string) {
  const pool = new Pool({ connectionString: process.env.DATABASE_URL });
  const { rows } = await pool.query('SELECT * FROM todos WHERE user_id = $1', [userId]);
  await pool.end();
  return rows;
}

export default async function Home() {
  const session = await auth();

  return (
    <div className="flex min-h-screen flex-col items-center justify-center p-4">
      <div className="w-full max-w-md text-center">
        {!session ? (
          <>
            <h1 className="mb-4 text-2xl">Welcome to the Todo App</h1>
            <p className="mb-4">Please sign in to access your todos.</p>
            <a href="/api/auth/signin" className="inline-block rounded border p-2">
              Sign In
            </a>
          </>
        ) : (
          <>
            <h1 className="mb-4 text-2xl">Welcome, {session.user?.name || session.user?.email}</h1>
            <TodoList initialTodos={await getTodos(session.user?.id as string)} />
            <a href="/api/auth/signout" className="mt-4 inline-block rounded border p-2">
              Sign Out
            </a>
          </>
        )}
      </div>
    </div>
  );
}
```

### 2. Layout with Authentication Status
```typescript
import type { Metadata } from 'next';
import { Inter } from 'next/font/google';
import './globals.css';
import { auth } from '@/auth';

const inter = Inter({ subsets: ['latin'] });

export const metadata: Metadata = {
  title: 'Create Next App',
  description: 'Generated by create next app',
};

async function UserInfoBar() {
  const session = await auth();
  if (!session) {
    return null;
  }

  return (
    <div className="bg-gray-100 px-4 py-2">
      <span className="text-gray-800">
        Welcome, {session.user?.name}!{' '}
        <a href="/api/auth/signout" className="text-blue-600 hover:underline">
          Sign out
        </a>
      </span>
    </div>
  );
}

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <UserInfoBar />
        {children}
      </body>
    </html>
  );
}
```

## Row-Level Security (RLS) Integration

### 1. Authenticated Queries with JWT
```typescript
'use server';

import { neon } from '@neondatabase/serverless';
import { getAccessToken } from '@auth0/nextjs-auth0';

export async function TodoList() {
    const sql = neon(process.env.DATABASE_AUTHENTICATED_URL!, {
        authToken: async () => {
            const { accessToken } = await getAccessToken();
            if (!accessToken) {
                throw new Error('No access token');
            }
            return accessToken;
        },
    });

    // WHERE filter is optional because of RLS.
    // But we send it anyway for performance reasons.
    const todos = await sql`SELECT * FROM todos WHERE user_id = auth.user_id()`;

    return (
        <ul>
            {todos.map((todo) => (
                <li key={todo.id}>{todo.task}</li>
            ))}
        </ul>
    );
}
```

### 2. Stytch Integration Example
```typescript
'use server';

import { neon } from '@neondatabase/serverless';
import { cookies } from 'next/headers';
import { Client } from 'stytch';

const client = new Client({
  project_id: process.env.STYTCH_PROJECT_ID as string,
  secret: process.env.STYTCH_SECRET as string,
});

async function getStytchSession() {
  const cookieStore = cookies();
  const sessionToken = cookieStore.get('stytch_session');
  if (!sessionToken?.value) {
    throw new Error('No session token found');
  }
  const response = await client.sessions.authenticate({
    session_token: sessionToken.value,
  });
  return response.session_jwt;
}

export default async function TodoList() {
  const sql = neon(process.env.DATABASE_AUTHENTICATED_URL!, {
    authToken: async () => {
      const sessionJWT = await getStytchSession();
      if (!sessionJWT) {
        throw new Error('No session JWT available');
      }
      return sessionJWT;
    },
  });

  const todos = await sql('SELECT * FROM todos WHERE user_id = auth.user_id()');

  return (
    <ul>
      {todos.map((todo) => (
        <li key={todo.id}>{todo.task}</li>
      ))}
    </ul>
  );
}
```

## API Routes

### 1. Create Todo API Endpoint
```typescript
import { NextResponse } from 'next/server';
import { auth } from '@/auth';
import { Pool } from '@neondatabase/serverless';

export async function POST(req: Request) {
  const session = await auth();
  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const { content } = await req.json();
  const pool = new Pool({ connectionString: process.env.DATABASE_URL });

  try {
    const { rows } = await pool.query(
      'INSERT INTO todos (user_id, content) VALUES ($1, $2) RETURNING *',
      [session.user.id, content]
    );
    return NextResponse.json(rows[0]);
  } catch (error) {
    return NextResponse.json({ error: 'Failed to create todo' }, { status: 500 });
  } finally {
    await pool.end();
  }
}
```

## Server Actions

### 1. User Message Management
```typescript
'use server';

import { auth } from '@/auth';
import { UserMessages } from './db/schema';
import { db } from './db';
import { redirect } from 'next/navigation';
import { eq } from 'drizzle-orm';

export async function createUserMessage(formData: FormData) {
  const session = await auth();
  if (!session) throw new Error('User not authenticated');

  const message = formData.get('message') as string;
  await db.insert(UserMessages).values({
    user_id: session.user?.id as string,
    message,
  });

  redirect('/');
}

export async function deleteUserMessage() {
  const session = await auth();
  if (!session) throw new Error('User not authenticated');

  await db.delete(UserMessages).where(eq(UserMessages.user_id, session.user?.id as string));
  redirect('/');
}
```

## Installation Commands

### 1. Project Setup
```bash
# Create Next.js project
npx create-next-app guide-neon-next-clerk --typescript --eslint --tailwind --use-npm --no-src-dir --app --import-alias "@/*"

# Navigate to project
cd guide-neon-next-authjs
```

### 2. Core Dependencies
```bash
# Auth.js and Neon
npm install next-auth@beta
npm install @auth/pg-adapter @neondatabase/serverless

# Drizzle ORM
npm install @neondatabase/serverless drizzle-orm
npm install -D drizzle-kit dotenv

# Authentication providers
npm install @clerk/nextjs
npm install @auth0/nextjs-auth0
```

### 3. Generate Auth Secret
```bash
npx auth secret
```

## Authentication Provider Configurations

### 1. Auth0 Configuration
```env
# .env.local
AUTH0_SECRET='random-32-byte-value'
AUTH0_BASE_URL='http://localhost:3000'
AUTH0_ISSUER_BASE_URL='https://YOUR_AUTH0_DOMAIN'
AUTH0_CLIENT_ID='YOUR_AUTH0_CLIENT_ID'
AUTH0_CLIENT_SECRET='YOUR_AUTH0_CLIENT_SECRET'
```

### 2. Okta Configuration
```env
# .env.local
AUTH_OKTA_ISSUER=YOUR_OKTA_ISSUER
AUTH_OKTA_ID=YOUR_CLIENT_ID
AUTH_OKTA_SECRET=YOUR_CLIENT_SECRET
AUTH_SECRET=YOUR_SECRET
```

### 3. Clerk Configuration
```env
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=**************
CLERK_SECRET_KEY=**************
```

## Advanced Integrations

### 1. SuperTokens Integration
```typescript
'use server';

import { neon } from '@neondatabase/serverless';
import { cookies } from "next/headers";

export default async function TodoList() {
    const parsed_cookies = await cookies();
    const accessToken = parsed_cookies.get("sAccessToken")?.value;
    const sql = neon(process.env.DATABASE_AUTHENTICATED_URL!, {
        authToken: async () => {
            const token = accessToken;
            if (!token) {
                throw new Error('No token found');
            }
            return token;
        },
    });

    const todos = await sql('select * from todos where user_id = auth.user_id()');

    return (
        <ul>
            {todos.map((todo) => (
                <li key={todo.id}>{todo.task}</li>
            ))}
        </ul>
    );
}
```

### 2. WorkOS AuthKit Integration
```typescript
'use server';

import { neon } from '@neondatabase/serverless';
import { withAuth } from '@workos-inc/authkit-nextjs';

export default async function TodoList() {
    const { user, accessToken } = await withAuth({ ensureSignedIn: true });
     if (!user) {
        throw new Error('No user');
    }

    const jwt = accessToken;

    const sql = neon(process.env.DATABASE_AUTHENTICATED_URL!, {
        authToken: async () => {
            if (!jwt) {
                throw new Error('No JWT token available');
            }
            return jwt;
        },
    });

    const todos = await sql('SELECT * FROM todos WHERE user_id = auth.user_id()');

    return (
        <ul>
            {todos.map((todo) => (
                <li key={todo.id}>{todo.task}</li>
            ))}
        </ul>
    );
}
```

## Development Commands

```bash
# Start development server
npm run dev

# Run at http://localhost:3000
```

---

**Note**: This documentation is sourced directly from the official Neon documentation website via Context7, ensuring accuracy and up-to-date information for Neon authentication with Next.js.